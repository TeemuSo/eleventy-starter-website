name: AI Edit with Aider

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Natural language prompt for Aider (e.g. 'Change hero title to Purrfect Caf√©')"
        required: true
        type: string

jobs:
  ai_edit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Aider
        run: |
          pip install "aider-chat[cli]"

      - name: üåê Fetch live site for context (optional)
        if: ${{ env.DEPLOY_URL != '' }}
        env:
          DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
        run: |
          echo "Fetching $DEPLOY_URL"
          curl -L "$DEPLOY_URL" -o _snapshot.html || true

      - name: Configure git author
        run: |
          git config user.name  "Aider Bot"
          git config user.email "aider@localhost"
          
      - name: ü§ñ Run Aider on prompt
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
        run: |
          extra=""
          if [ -f _snapshot.html ]; then
            extra="-C _snapshot.html"
          fi
      
          # --yes  : auto-accept the AI‚Äôs edits
          # -m     : treat workflow input as the chat message
          # --commit : commit the diff
          aider \
            --yes \
            --map-refresh always \
            --map-tokens 6000 \
            --model gemini \
            -m "${{ github.event.inputs.prompt }}" \
            $(git ls-files) \
            $extra --commit

      - name: üöÄ Push changes back
        run: |
          git push
